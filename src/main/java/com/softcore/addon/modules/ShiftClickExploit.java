package com.softcore.addon.modules;

import com.softcore.addon.SoftcoreAddon;
import meteordevelopment.meteorclient.events.packets.PacketEvent;
import meteordevelopment.meteorclient.events.world.TickEvent;
import meteordevelopment.meteorclient.settings.*;
import meteordevelopment.meteorclient.systems.modules.Module;
import meteordevelopment.meteorclient.utils.player.ChatUtils;
import meteordevelopment.orbit.EventHandler;
import net.minecraft.network.packet.c2s.play.ClickSlotC2SPacket;
import net.minecraft.network.packet.c2s.play.CloseHandledScreenC2SPacket;

public class ShiftClickExploit extends Module {
    private final SettingGroup sgGeneral = settings.getDefaultGroup();
    private final SettingGroup sgTiming = settings.createGroup("Timing");

    private final Setting<Boolean> autoCloseAfterShift = sgGeneral.add(new BoolSetting.Builder()
        .name("auto-close")
        .description("Automatically close inventory immediately after shift-click")
        .defaultValue(false)
        .build()
    );

    private final Setting<Integer> closeDelayTicks = sgTiming.add(new IntSetting.Builder()
        .name("close-delay")
        .description("Ticks to wait before closing (0 = instant, during item distribution)")
        .defaultValue(0)
        .min(0)
        .max(10)
        .sliderMax(10)
        .visible(autoCloseAfterShift::get)
        .build()
    );

    private final Setting<Boolean> blockClosePacket = sgGeneral.add(new BoolSetting.Builder()
        .name("block-close-packet")
        .description("Block the close packet (client closes, server thinks still open)")
        .defaultValue(false)
        .build()
    );

    private final Setting<Boolean> notifyOnShift = sgGeneral.add(new BoolSetting.Builder()
        .name("notify")
        .description("Notify when shift-click is detected")
        .defaultValue(true)
        .build()
    );

    private boolean shiftClickDetected = false;
    private int ticksUntilClose = 0;

    public ShiftClickExploit() {
        super(SoftcoreAddon.CATEGORY, "shift-click-exploit", 
            "Tests Death Chest MOVE_TO_OTHER_INVENTORY desync exploit. " +
            "The plugin manually reimplements shift-click, closing during distribution may cause desync.");
    }

    @Override
    public void onActivate() {
        shiftClickDetected = false;
        ticksUntilClose = 0;
        info("§eShift-click exploit tester activated!");
        info("§71. Shift-click items from death chest");
        info("§72. Close during item distribution to test desync");
    }

    @EventHandler
    private void onSendPacket(PacketEvent.Send event) {
        // Detect inventory clicks (includes shift-clicks)
        if (event.packet instanceof ClickSlotC2SPacket) {
            ClickSlotC2SPacket packet = (ClickSlotC2SPacket) event.packet;
            
            // Note: Use SHIFT+CLICK on items manually
            shiftClickDetected = true;
            
            if (notifyOnShift.get()) {
                ChatUtils.info("§6⚡ Inventory CLICK detected! If you shift-clicked: " +
                    (autoCloseAfterShift.get() ? 
                        "Auto-closing in " + closeDelayTicks.get() + " ticks (during distribution)" : 
                        "Close manually IMMEDIATELY to test exploit"));
            }

            if (autoCloseAfterShift.get()) {
                ticksUntilClose = closeDelayTicks.get();
            }
        }

        // Handle close packet
        if (event.packet instanceof CloseHandledScreenC2SPacket) {
            if (shiftClickDetected && blockClosePacket.get()) {
                event.cancel();
                shiftClickDetected = false;
                if (notifyOnShift.get()) {
                    ChatUtils.info("§c❌ BLOCKED close packet! UI closed client-side, server thinks still open!");
                    ChatUtils.info("§c   Items may be desynced between client/server!");
                }
            }
        }
    }

    @EventHandler
    private void onTick(TickEvent.Post event) {
        if (ticksUntilClose > 0) {
            ticksUntilClose--;
            if (ticksUntilClose == 0 && mc.currentScreen != null) {
                mc.player.closeHandledScreen();
                shiftClickDetected = false;
                if (notifyOnShift.get()) {
                    ChatUtils.info("§e✓ Closed during item distribution!");
                }
            }
        }
    }
}
